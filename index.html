<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>원가 계산기</title>
  <style>
    :root{
      --bg:#f5f6f8;
      --card:#ffffff;
      --line:#e9ebef;
      --text:#111;
      --sub:#6b7280;
      --brand:#10cfc9; /* 배민 느낌 민트 */
      --brand2:#0fbab5;
      --danger:#e11d48;
      --shadow:0 8px 24px rgba(0,0,0,.06);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
      background:var(--bg); color:var(--text);
    }
    .wrap{max-width:980px; margin:0 auto; padding:14px 12px 96px}
    .topbar{
      position:sticky; top:0; z-index:50;
      background:rgba(245,246,248,.85); backdrop-filter:saturate(1.2) blur(10px);
      padding:10px 0 12px;
    }
    .titleRow{display:flex; gap:10px; align-items:center; padding:0 12px}
    .title{font-weight:900; font-size:18px}
    .pillBtn{
      margin-left:auto;
      border:1px solid var(--line);
      background:#fff;
      border-radius:999px;
      padding:8px 12px;
      font-weight:800;
      cursor:pointer;
    }
    .pillBtn.on{background:#111; color:#fff; border-color:#111;}
    .controls{
      display:flex; gap:8px; flex-wrap:wrap;
      padding:10px 12px 0;
    }
    select, input[type="text"], input[type="number"]{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      background:#fff;
      font-weight:700;
      outline:none;
    }
    .sizeSeg{display:flex; gap:6px; align-items:center}
    .segBtn{
      border:1px solid var(--line);
      background:#fff;
      border-radius:999px;
      padding:10px 14px;
      font-weight:900;
      cursor:pointer;
    }
    .segBtn.active{border:2px solid var(--brand2); background:#e6fffe}
    .ghostBtn{
      border:1px solid var(--line);
      background:#fff;
      border-radius:12px;
      padding:10px 12px;
      font-weight:800;
      cursor:pointer;
    }
    .summaryGrid{
      padding:12px;
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:10px;
    }
    @media (max-width:860px){
      .summaryGrid{grid-template-columns: repeat(2, minmax(0,1fr));}
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
    }
    .sumCard{padding:12px}
    .sumTitle{font-size:12px; color:var(--sub); font-weight:800}
    .sumValue{margin-top:6px; font-size:18px; font-weight:900}
    .sumValue.bad{color:var(--danger)}
    .feeRow{
      padding:0 12px 12px;
      display:flex; gap:12px; flex-wrap:wrap;
      color:#4b5563; font-size:12px; font-weight:700;
    }
    .section{
      margin-top:12px;
      overflow:hidden;
    }
    .secHead{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
    }
    .secTitle{font-weight:900}
    .secSub{margin-top:4px; font-size:12px; color:var(--sub); font-weight:700}
    .optList{padding:0}
    .optRow{
      display:grid;
      grid-template-columns: 28px 1fr auto;
      gap:10px;
      align-items:center;
      padding:12px 14px;
      border-bottom:1px solid #f0f2f6;
    }
    .optRow:last-child{border-bottom:0}
    .optName{font-weight:900}
    .optMeta{margin-top:3px; font-size:12px; color:var(--sub); font-weight:700}
    .rightMini{min-width:120px; display:flex; justify-content:flex-end}
    input[type="radio"], input[type="checkbox"]{width:18px; height:18px}
    .qty{
      display:flex; align-items:center; gap:8px;
      border:1px solid var(--line);
      border-radius:12px;
      padding:6px 8px;
      background:#fff;
    }
    .qty button{
      width:28px; height:28px; border-radius:10px;
      border:1px solid var(--line);
      background:#fff;
      font-weight:900;
      cursor:pointer;
    }
    .qty .n{min-width:22px; text-align:center; font-weight:900}
    .adminBox{
      margin:12px;
      padding:12px;
      background:#f9fafb;
      border:1px solid var(--line);
      border-radius:14px;
    }
    .adminGrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:10px;
      margin-top:10px;
    }
    @media (max-width:640px){
      .adminGrid{grid-template-columns:1fr;}
    }
    .field label{font-size:12px; color:#374151; font-weight:900}
    .field input{width:100%}
    .inlineEdit{
      margin-top:8px;
      display:flex; flex-wrap:wrap;
      gap:8px;
    }
    .inlineEdit .mini{
      display:flex; gap:6px; align-items:center;
      font-size:12px; font-weight:800; color:#6b7280;
    }
    .inlineEdit input{
      width:120px;
      padding:8px 10px;
      border-radius:12px;
    }
    .tableCard{margin-top:12px; overflow:hidden}
    .tableHead{padding:12px 14px; border-bottom:1px solid var(--line); font-weight:900}
    .tableBody{padding:12px}
    .rowBox{
      display:grid;
      grid-template-columns: 1fr auto auto auto;
      gap:10px;
      align-items:center;
      padding:12px;
      border:1px solid #f0f2f6;
      border-radius:14px;
      margin-bottom:8px;
      background:#fff;
    }
    .rowBox:last-child{margin-bottom:0}
    .profit{font-weight:900}
    .profit.pos{color:var(--brand2)}
    .profit.neg{color:var(--danger)}
    .divider{width:1px; height:36px; background:var(--line)}
    .hint{margin-top:12px; color:#6b7280; font-size:12px; line-height:1.55}
    .bottomBar{
      position:fixed; left:0; right:0; bottom:0; z-index:60;
      padding:10px 12px calc(10px + env(safe-area-inset-bottom));
      background:rgba(245,246,248,.92);
      border-top:1px solid rgba(233,235,239,.8);
      backdrop-filter:saturate(1.2) blur(10px);
    }
    .bottomInner{
      max-width:980px; margin:0 auto;
      display:flex; gap:10px; align-items:center;
    }
    .cta{
      margin-left:auto;
      background:var(--brand);
      color:#003b39;
      border:0;
      border-radius:14px;
      padding:14px 16px;
      font-weight:1000;
      cursor:pointer;
      min-width:220px;
      box-shadow:0 10px 26px rgba(16,207,201,.22);
    }
    .cta small{display:block; font-size:11px; font-weight:900; opacity:.75}
    .cta strong{display:block; font-size:18px; font-weight:1000}
    .badge{display:inline-flex; align-items:center; gap:6px}
    .dot{width:8px; height:8px; border-radius:50%; background:var(--brand2)}
    .muted{color:var(--sub); font-size:12px; font-weight:800}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="wrap" style="padding-bottom:0">
      <div class="card">
        <div class="titleRow" style="padding:12px 14px">
          <div>
            <div class="title" id="menuTitle">원가 계산기</div>
            <div class="muted">배민 옵션 UI 느낌 · 로컬 저장 · 링크 공유(GitHub Pages)</div>
          </div>
          <button class="pillBtn" id="adminBtn">관리자</button>
        </div>

        <div class="controls">
          <select id="platformSel"></select>

          <div class="sizeSeg" id="sizeSeg"></div>

          <select id="couponSel"></select>

          <select id="extraDeliverySel"></select>

          <button class="ghostBtn" id="resetBtn">초기화</button>
        </div>

        <div class="summaryGrid">
          <div class="sumCard card">
            <div class="sumTitle">총 결제금액(쿠폰 전)</div>
            <div class="sumValue" id="grossPrice">-</div>
          </div>
          <div class="sumCard card">
            <div class="sumTitle">실매출(쿠폰 적용)</div>
            <div class="sumValue" id="netRevenue">-</div>
          </div>
          <div class="sumCard card">
            <div class="sumTitle">총 원가</div>
            <div class="sumValue" id="totalCost">-</div>
          </div>
          <div class="sumCard card">
            <div class="sumTitle" id="profitTitle">실마진</div>
            <div class="sumValue" id="profit">-</div>
          </div>
        </div>

        <div class="feeRow">
          <span>플랫폼수수료: <b id="platformFee">-</b></span>
          <span>카드수수료: <b id="cardFee">-</b></span>
          <span>배달비: <b id="deliveryFee">-</b></span>
        </div>

        <div class="adminBox" id="adminBox" style="display:none">
          <div style="font-weight:1000">관리자 설정</div>
          <div class="adminGrid">
            <div class="field">
              <label>메뉴명</label>
              <input type="text" id="adminMenuName" />
            </div>
            <div class="field">
              <label>관리자 PIN (기본 0000)</label>
              <input type="text" id="adminPin" />
            </div>

            <div class="field">
              <label><span id="adminSizeLabel1">M</span> 판매가</label>
              <input type="number" id="adminSizePrice" inputmode="numeric" />
            </div>
            <div class="field">
              <label><span id="adminSizeLabel2">M</span> 기본 원가</label>
              <input type="number" id="adminSizeCost" inputmode="decimal" />
            </div>

            <div class="field">
              <label>플랫폼 수수료율 (예: 0.0858 = 8.58%)</label>
              <input type="number" step="0.0001" id="adminPlatformRate" />
            </div>
            <div class="field">
              <label>카드 수수료율 (예: 0.03 = 3%)</label>
              <input type="number" step="0.0001" id="adminCardRate" />
            </div>

            <div class="field">
              <label>플랫폼 기본 배달비</label>
              <input type="number" id="adminPlatformDelivery" inputmode="numeric" />
            </div>
          </div>
          <div class="hint">
            * 옵션 원가/옵션가도 아래 옵션 리스트에서 바로 수정 가능 (관리자 ON일 때만 표시)
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div id="sections"></div>

    <div class="card tableCard">
      <div class="tableHead">선택 옵션 손익 (옵션 단독)</div>
      <div class="tableBody" id="profitRows"></div>
    </div>

    <div class="hint">
      - 수수료는 <b>쿠폰 적용된 실매출</b> 기준으로 계산됨<br/>
      - 값은 브라우저에 저장됨(같은 기기/브라우저에서 유지). 다른 기기는 동일 설정을 다시 입력해야 함.<br/>
      - “진짜 공유”는 GitHub Pages URL로 접속해야 함.
    </div>
  </div>

  <div class="bottomBar">
    <div class="bottomInner">
      <div class="badge">
        <span class="dot"></span>
        <span class="muted">배민처럼 옵션 선택 → 위쪽이 자동 계산</span>
      </div>
      <button class="cta" id="ctaBtn" type="button">
        <small>현재 실마진</small>
        <strong id="ctaProfit">-</strong>
      </button>
    </div>
  </div>

<script>
/** =========================
 *  Helpers
 *  ========================= */
const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
const toNumber = (v, fallback=0) => {
  const n = (typeof v === 'number') ? v : Number(String(v).replace(/,/g,''));
  return Number.isFinite(n) ? n : fallback;
};
const won = (n) => (Math.round(n)).toLocaleString('ko-KR') + '원';
const pct = (n) => (Math.round(n*10)/10).toFixed(1) + '%';

const LS = {
  get(key, fallback){
    try{ const raw = localStorage.getItem(key); if(!raw) return fallback; return JSON.parse(raw); }
    catch{ return fallback; }
  },
  set(key, val){
    try{ localStorage.setItem(key, JSON.stringify(val)); }catch{}
  }
};

/** =========================
 *  Data model
 *  ========================= */
const SizeKeys = ['S','M','L'];

const DEFAULT = {
  adminPin: "0000",
  menu: {
    name: "충성콤비네이션",
    sizes: {
      S: { price: 14900, baseCost: 3682 },
      M: { price: 19900, baseCost: 0 },
      L: { price: 23900, baseCost: 5850.24 },
    }
  },
  platforms: {
    BAEMIN_DELIVERY: { name:'배민', platformFeeRate:0.0858, cardFeeRate:0.03, deliveryFee:3400 },
    BAEMIN_STORE:    { name:'배민 가게배달', platformFeeRate:0.0748, cardFeeRate:0.03, deliveryFee:3400 },
    BAEMIN_PICKUP:   { name:'배민 포장', platformFeeRate:0.0748, cardFeeRate:0.03, deliveryFee:0 },
    YOGIYO_DELIVERY: { name:'요기요', platformFeeRate:0.0737, cardFeeRate:0.03, deliveryFee:3190 },
    YOGIYO_STORE:    { name:'요기요 가게배달', platformFeeRate:0.1067, cardFeeRate:0.03, deliveryFee:3190 },
    YOGIYO_PICKUP:   { name:'요기요 포장', platformFeeRate:0.0847, cardFeeRate:0.03, deliveryFee:0 },
    COUPANG_DELIVERY:{ name:'쿠팡이츠', platformFeeRate:0.0858, cardFeeRate:0.03, deliveryFee:3730 },
    COUPANG_PICKUP:  { name:'쿠팡 포장', platformFeeRate:0.0858, cardFeeRate:0.03, deliveryFee:0 },
  },
  // 배민 옵션 UI 구조에 맞춘 그룹들
  optionGroups: [
    { id:"PRICE",   title:"가격", subtitle:"사이즈 선택(필수)", kind:"radio" },
    { id:"REVIEW1", title:"리뷰이벤트1", subtitle:"필수", kind:"radio" },
    { id:"REVIEW2", title:"리뷰이벤트2", subtitle:"필수", kind:"radio" },
    { id:"PICKLE",  title:"피클선택(기본미제공)", subtitle:"필수", kind:"radio" },
    { id:"SAUCE_QTY", title:"소스 추가선택(기본미제공)", subtitle:"최대 4개", kind:"check_qty" },
    { id:"SAUCE_AMOUNT", title:"피자 소스양 선택", subtitle:"필수", kind:"radio" },
    { id:"DOUGH",   title:"도우 선택", subtitle:"필수", kind:"radio" },
    { id:"EDGE",    title:"엣지 선택", subtitle:"필수", kind:"radio" },
    { id:"TOPPING", title:"토핑 추가선택", subtitle:"최대 2개", kind:"check_limit" , maxSelect:2 },
    { id:"SIDE",    title:"사이드메뉴 추가선택", subtitle:"최대 1개", kind:"check_limit", maxSelect:1 },
    { id:"DRINK",   title:"음료 추가선택", subtitle:"최대 1개", kind:"check_limit", maxSelect:1 },
  ],
  options: [
    // REVIEW1 (필수)
    { id:"rv1_next", groupId:"REVIEW1", type:"radio", name:"다음에 참여할게요", priceDelta:0, costDelta:0, adminEditable:true },
    { id:"rv1_mozz", groupId:"REVIEW1", type:"radio", name:"1. 모짜렐라 치즈 추가", priceDelta:0, costDelta:0, adminEditable:true },
    { id:"rv1_cheeseball2", groupId:"REVIEW1", type:"radio", name:"2. 치즈볼 2알", priceDelta:500, costDelta:0, adminEditable:true },
    { id:"rv1_shrimp3", groupId:"REVIEW1", type:"radio", name:"3. 새우링 3P", priceDelta:500, costDelta:0, adminEditable:true },
    { id:"rv1_pastry2", groupId:"REVIEW1", type:"radio", name:"4. 페스츄리 2P", priceDelta:500, costDelta:0, adminEditable:true },
    { id:"rv1_cajun", groupId:"REVIEW1", type:"radio", name:"5. 케이준 감자튀김", priceDelta:500, costDelta:0, adminEditable:true },
    { id:"rv1_buffalo3", groupId:"REVIEW1", type:"radio", name:"6. 버팔로윙 3P", priceDelta:500, costDelta:0, adminEditable:true },
    { id:"rv1_tender2", groupId:"REVIEW1", type:"radio", name:"7. 바삭텐더 2P", priceDelta:500, costDelta:0, adminEditable:true },
    { id:"rv1_edge_cheese", groupId:"REVIEW1", type:"radio", name:"8. 치즈크러스트 추가", priceDelta:1000, costDelta:0, adminEditable:true },
    { id:"rv1_edge_sweet", groupId:"REVIEW1", type:"radio", name:"9. 고구마 크러스트 추가", priceDelta:1000, costDelta:0, adminEditable:true },
    { id:"rv1_drink125", groupId:"REVIEW1", type:"radio", name:"10. 랜덤음료 1.25L", priceDelta:1000, costDelta:0, adminEditable:true },
    { id:"rv1_spag", groupId:"REVIEW1", type:"radio", name:"11. 치즈오븐스파게티", priceDelta:2000, costDelta:0, adminEditable:true },
    { id:"rv1_soldout", groupId:"REVIEW1", type:"radio", name:"메뉴 품절시 랜덤 발송됩니다.", priceDelta:0, costDelta:0, adminEditable:true },

    // REVIEW2 (필수 / +0 구성)
    { id:"rv2_next", groupId:"REVIEW2", type:"radio", name:"다음에 참여할게요", priceDelta:0, costDelta:0, adminEditable:true },
    { id:"rv2_pickle", groupId:"REVIEW2", type:"radio", name:"1. 피클+", priceDelta:0, costDelta:0, adminEditable:true },
    { id:"rv2_garlic", groupId:"REVIEW2", type:"radio", name:"2. 갈릭소스+", priceDelta:0, costDelta:0, adminEditable:true },
    { id:"rv2_hot", groupId:"REVIEW2", type:"radio", name:"3. 핫소스+", priceDelta:0, costDelta:0, adminEditable:true },
    { id:"rv2_yogurt", groupId:"REVIEW2", type:"radio", name:"4. 요거트소스+", priceDelta:0, costDelta:0, adminEditable:true },
    { id:"rv2_parm", groupId:"REVIEW2", type:"radio", name:"5. 파마산+", priceDelta:0, costDelta:0, adminEditable:true },

    // PICKLE (필수)
    { id:"pickle_x", groupId:"PICKLE", type:"radio", name:"피클X", priceDelta:0, costDelta:0, adminEditable:true },
    { id:"pickle_o", groupId:"PICKLE", type:"radio", name:"피클O", priceDelta:500, costDelta:0, adminEditable:true },

    // SAUCE_AMOUNT (필수 / +0)
    { id:"sauce_amt_normal", groupId:"SAUCE_AMOUNT", type:"radio", name:"보통이요", priceDelta:0, costDelta:0, adminEditable:true },
    { id:"sauce_amt_less", groupId:"SAUCE_AMOUNT", type:"radio", name:"적게 (싱거울 수 있습니다)", priceDelta:0, costDelta:0, adminEditable:true },
    { id:"sauce_amt_more", groupId:"SAUCE_AMOUNT", type:"radio", name:"많이 (짤 수 있습니다)", priceDelta:0, costDelta:0, adminEditable:true },

    // DOUGH (필수 / +0)
    { id:"dough_milk", groupId:"DOUGH", type:"radio", name:"우유도우(쫄깃도우)", priceDelta:0, costDelta:0, adminEditable:true },
    { id:"dough_black", groupId:"DOUGH", type:"radio", name:"담백한 흑미도우(얇은도우)", priceDelta:0, costDelta:0, adminEditable:true },

    // EDGE (필수)
    { id:"edge_ori", groupId:"EDGE", type:"radio", name:"오리지널", priceDelta:0, costDelta:0, adminEditable:true },
    { id:"edge_cheese", groupId:"EDGE", type:"radio", name:"치즈크러스트(빵안에 치즈)", priceDelta:2500, costDelta:0, adminEditable:true },
    { id:"edge_sweet", groupId:"EDGE", type:"radio", name:"고구마치즈크러스트(빵안에 고구마무스+치즈)", priceDelta:3000, costDelta:0, adminEditable:true },
    { id:"edge_gold", groupId:"EDGE", type:"radio", name:"골드(빵안에 고구마무스+체다치즈)", priceDelta:3500, costDelta:0, adminEditable:true },

    // TOPPING (최대 2개)
    { id:"top_cheese", groupId:"TOPPING", type:"check", name:"치즈 추가", priceDelta:3000, costDelta:0, adminEditable:true },
    { id:"top_pepperoni", groupId:"TOPPING", type:"check", name:"페퍼로니 추가", priceDelta:2000, costDelta:0, adminEditable:true },
    { id:"top_pineapple", groupId:"TOPPING", type:"check", name:"파인애플 추가", priceDelta:2000, costDelta:0, adminEditable:true },
    { id:"top_sweet", groupId:"TOPPING", type:"check", name:"고구마무스 추가", priceDelta:2000, costDelta:0, adminEditable:true },
    { id:"top_bacon", groupId:"TOPPING", type:"check", name:"베이컨 추가", priceDelta:2000, costDelta:0, adminEditable:true },
    { id:"top_mush", groupId:"TOPPING", type:"check", name:"버섯 추가", priceDelta:1000, costDelta:0, adminEditable:true },
    { id:"top_piment", groupId:"TOPPING", type:"check", name:"피망 추가", priceDelta:1000, costDelta:0, adminEditable:true },
    { id:"top_onion", groupId:"TOPPING", type:"check", name:"양파 추가", priceDelta:1000, costDelta:0, adminEditable:true },
    { id:"top_olive", groupId:"TOPPING", type:"check", name:"올리브 추가", priceDelta:1000, costDelta:0, adminEditable:true },

    // SIDE (최대 1개)
    { id:"side_pasta", groupId:"SIDE", type:"check", name:"치즈빨오븐파스타 추가", priceDelta:5900, costDelta:0, adminEditable:true },
    { id:"side_garlicpie", groupId:"SIDE", type:"check", name:"페스츄리갈릭파이 4p 추가", priceDelta:3900, costDelta:0, adminEditable:true },
    { id:"side_fries", groupId:"SIDE", type:"check", name:"케이준감자튀김 추가", priceDelta:3900, costDelta:0, adminEditable:true },
    { id:"side_tender5", groupId:"SIDE", type:"check", name:"바삭촉촉텐더 5p 추가", priceDelta:6900, costDelta:0, adminEditable:true },

    // DRINK (최대 1개)
    { id:"drink_coke500", groupId:"DRINK", type:"check", name:"콜라 500ml", priceDelta:2000, costDelta:0, adminEditable:true },
    { id:"drink_coke125", groupId:"DRINK", type:"check", name:"콜라 1.25L", priceDelta:2500, costDelta:0, adminEditable:true },

    // SAUCE_QTY (최대 4개) - 수량형
    { id:"sq_pickle", groupId:"SAUCE_QTY", type:"check_qty", name:"피클 추가", priceDelta:500, costDelta:0, maxQty:4, adminEditable:true },
    { id:"sq_garlic", groupId:"SAUCE_QTY", type:"check_qty", name:"갈릭소스 추가", priceDelta:500, costDelta:0, maxQty:4, adminEditable:true },
    { id:"sq_yogurt", groupId:"SAUCE_QTY", type:"check_qty", name:"요거트소스 추가", priceDelta:500, costDelta:0, maxQty:4, adminEditable:true },
    { id:"sq_hot", groupId:"SAUCE_QTY", type:"check_qty", name:"핫소스 추가", priceDelta:200, costDelta:0, maxQty:4, adminEditable:true },
    { id:"sq_parm", groupId:"SAUCE_QTY", type:"check_qty", name:"파마산치즈가루 추가", priceDelta:200, costDelta:0, maxQty:4, adminEditable:true },
    { id:"sq_honey", groupId:"SAUCE_QTY", type:"check_qty", name:"허니머스타드", priceDelta:500, costDelta:0, maxQty:4, adminEditable:true },
    { id:"sq_chili", groupId:"SAUCE_QTY", type:"check_qty", name:"칠리", priceDelta:500, costDelta:0, maxQty:4, adminEditable:true },
  ]
};

const KEYS = {
  cfg: "cost_html_cfg_v1",
  state: "cost_html_state_v1",
};

/** =========================
 *  Load / init
 *  ========================= */
let cfg = LS.get(KEYS.cfg, DEFAULT);
let state = LS.get(KEYS.state, {
  platformKey: "BAEMIN_DELIVERY",
  size: "M",
  coupon: 0,
  storeDeliveryExtra: 0,
  adminOn: false,
  radio: {
    REVIEW1:"rv1_next",
    REVIEW2:"rv2_next",
    PICKLE:"pickle_x",
    SAUCE_AMOUNT:"sauce_amt_normal",
    DOUGH:"dough_milk",
    EDGE:"edge_ori",
  },
  checked: {},
  qty: {},
});

function save(){ LS.set(KEYS.cfg, cfg); LS.set(KEYS.state, state); }

/** =========================
 *  DOM refs
 *  ========================= */
const $ = (id)=>document.getElementById(id);

const platformSel = $("platformSel");
const sizeSeg = $("sizeSeg");
const couponSel = $("couponSel");
const extraDeliverySel = $("extraDeliverySel");
const resetBtn = $("resetBtn");
const sections = $("sections");
const profitRows = $("profitRows");

const adminBtn = $("adminBtn");
const adminBox = $("adminBox");
const adminMenuName = $("adminMenuName");
const adminPin = $("adminPin");
const adminSizePrice = $("adminSizePrice");
const adminSizeCost = $("adminSizeCost");
const adminSizeLabel1 = $("adminSizeLabel1");
const adminSizeLabel2 = $("adminSizeLabel2");
const adminPlatformRate = $("adminPlatformRate");
const adminCardRate = $("adminCardRate");
const adminPlatformDelivery = $("adminPlatformDelivery");

/** =========================
 *  Render controls
 *  ========================= */
function renderTop(){
  $("menuTitle").textContent = cfg.menu.name;

  // platform options
  platformSel.innerHTML = "";
  Object.keys(cfg.platforms).forEach((k)=>{
    const opt = document.createElement("option");
    opt.value = k;
    opt.textContent = cfg.platforms[k].name;
    platformSel.appendChild(opt);
  });
  platformSel.value = state.platformKey;

  // size seg
  sizeSeg.innerHTML = "";
  SizeKeys.forEach((s)=>{
    const b = document.createElement("button");
    b.className = "segBtn" + (state.size===s ? " active":"");
    b.textContent = s;
    b.onclick = ()=>{ state.size=s; ensureRadioDefaults(); save(); rerender(); };
    sizeSeg.appendChild(b);
  });

  // coupon
  couponSel.innerHTML = "";
  const coupons = [0,1000,2000,3000,4000,5000,7000,10000];
  coupons.forEach((v)=>{
    const opt = document.createElement("option");
    opt.value = String(v);
    opt.textContent = v===0 ? "쿠폰 없음" : `쿠폰 ${v.toLocaleString()}원`;
    couponSel.appendChild(opt);
  });
  couponSel.value = String(state.coupon);

  // extra delivery
  extraDeliverySel.innerHTML = "";
  const extras = [0,1000,2000,3000,4000,5000];
  extras.forEach((v)=>{
    const opt = document.createElement("option");
    opt.value = String(v);
    opt.textContent = v===0 ? "추가 배달비 없음" : `추가 배달비 ${v.toLocaleString()}원`;
    extraDeliverySel.appendChild(opt);
  });
  extraDeliverySel.value = String(state.storeDeliveryExtra);

  // admin btn
  adminBtn.className = "pillBtn" + (state.adminOn ? " on":"");
  adminBox.style.display = state.adminOn ? "block":"none";

  // admin fields
  adminMenuName.value = cfg.menu.name;
  adminPin.value = cfg.adminPin || "0000";
  adminSizeLabel1.textContent = state.size;
  adminSizeLabel2.textContent = state.size;
  adminSizePrice.value = cfg.menu.sizes[state.size].price;
  adminSizeCost.value = cfg.menu.sizes[state.size].baseCost;

  const p = cfg.platforms[state.platformKey];
  adminPlatformRate.value = p.platformFeeRate;
  adminCardRate.value = p.cardFeeRate;
  adminPlatformDelivery.value = p.deliveryFee;
}

platformSel.addEventListener("change",(e)=>{
  state.platformKey = e.target.value;
  save(); rerender();
});
couponSel.addEventListener("change",(e)=>{
  state.coupon = toNumber(e.target.value,0);
  save(); rerender();
});
extraDeliverySel.addEventListener("change",(e)=>{
  state.storeDeliveryExtra = toNumber(e.target.value,0);
  save(); rerender();
});
resetBtn.addEventListener("click",()=>{
  state.coupon=0;
  state.storeDeliveryExtra=0;
  state.checked={};
  state.qty={};
  // radio는 유지(배민도 보통 유지 느낌)
  save(); rerender();
});

adminBtn.addEventListener("click",()=>{
  if(state.adminOn){
    state.adminOn=false; save(); rerender(); return;
  }
  const pin = prompt("관리자 PIN 입력");
  if(pin === (cfg.adminPin || "0000")){
    state.adminOn=true; save(); rerender();
  }else{
    alert("PIN이 틀렸습니다.");
  }
});

function hookAdminInputs(){
  adminMenuName.addEventListener("input",(e)=>{
    cfg.menu.name = e.target.value || "원가 계산기";
    save(); rerender();
  });
  adminPin.addEventListener("input",(e)=>{
    cfg.adminPin = e.target.value || "0000";
    save();
  });
  adminSizePrice.addEventListener("input",(e)=>{
    cfg.menu.sizes[state.size].price = toNumber(e.target.value,0);
    save(); rerender();
  });
  adminSizeCost.addEventListener("input",(e)=>{
    cfg.menu.sizes[state.size].baseCost = toNumber(e.target.value,0);
    save(); rerender();
  });
  adminPlatformRate.addEventListener("input",(e)=>{
    cfg.platforms[state.platformKey].platformFeeRate = toNumber(e.target.value,0);
    save(); rerender();
  });
  adminCardRate.addEventListener("input",(e)=>{
    cfg.platforms[state.platformKey].cardFeeRate = toNumber(e.target.value,0);
    save(); rerender();
  });
  adminPlatformDelivery.addEventListener("input",(e)=>{
    cfg.platforms[state.platformKey].deliveryFee = toNumber(e.target.value,0);
    save(); rerender();
  });
}

/** =========================
 *  Options rendering
 *  ========================= */
function getGroupMeta(groupId){
  return cfg.optionGroups.find(g=>g.id===groupId);
}
function getOptionsByGroup(groupId){
  return cfg.options.filter(o=>o.groupId===groupId);
}

function ensureRadioDefaults(){
  // 필수 라디오 그룹은 값이 없으면 첫번째로
  const must = ["REVIEW1","REVIEW2","PICKLE","SAUCE_AMOUNT","DOUGH","EDGE"];
  must.forEach(gid=>{
    const list = getOptionsByGroup(gid);
    if(!list.length) return;
    const cur = state.radio[gid];
    if(!cur || !list.some(o=>o.id===cur)){
      state.radio[gid]=list[0].id;
    }
  });
}

function renderSections(){
  sections.innerHTML = "";

  cfg.optionGroups.forEach(group=>{
    // PRICE 그룹은 UI에 표시만 하고 실제는 sizeSeg로 처리하므로 생략 가능
    if(group.id==="PRICE") return;

    const list = getOptionsByGroup(group.id);
    if(!list.length) return;

    const sec = document.createElement("div");
    sec.className = "card section";

    const head = document.createElement("div");
    head.className = "secHead";
    head.innerHTML = `<div class="secTitle">${group.title}</div>
                      <div class="secSub">${group.subtitle || ""}</div>`;
    sec.appendChild(head);

    const body = document.createElement("div");
    body.className = "optList";

    list.forEach(opt=>{
      const row = document.createElement("div");
      row.className = "optRow";

      const left = document.createElement("div");
      left.style.display="flex";
      left.style.justifyContent="center";

      const mid = document.createElement("div");
      const right = document.createElement("div");
      right.className="rightMini";

      // selector
      if(opt.type==="radio"){
        const r = document.createElement("input");
        r.type="radio";
        r.name = "rg_"+opt.groupId;
        r.checked = state.radio[opt.groupId]===opt.id;
        r.addEventListener("change",()=>{
          state.radio[opt.groupId]=opt.id;
          save(); rerender();
        });
        left.appendChild(r);
      }else if(opt.type==="check"){
        const c = document.createElement("input");
        c.type="checkbox";
        c.checked = !!state.checked[opt.id];
        c.addEventListener("change",()=>{
          // check_limit 처리
          const g = getGroupMeta(opt.groupId);
          if(g && g.kind==="check_limit" && c.checked){
            const max = g.maxSelect || 99;
            const checkedInGroup = getOptionsByGroup(opt.groupId).filter(o=>state.checked[o.id]).map(o=>o.id);
            if(checkedInGroup.length >= max){
              // 가장 먼저 선택된 거 해제(배민 느낌으로 제한)
              state.checked[checkedInGroup[0]] = false;
            }
          }
          state.checked[opt.id] = !state.checked[opt.id];
          save(); rerender();
        });
        left.appendChild(c);
      }else if(opt.type==="check_qty"){
        const c = document.createElement("input");
        c.type="checkbox";
        const q = clamp(toNumber(state.qty[opt.id],0),0,opt.maxQty||99);
        c.checked = q>0;
        c.addEventListener("change",()=>{
          state.qty[opt.id] = (q>0 ? 0 : 1);
          save(); rerender();
        });
        left.appendChild(c);

        // qty stepper
        const step = document.createElement("div");
        step.className="qty";
        const minus = document.createElement("button");
        minus.textContent="-";
        minus.onclick=()=>{ state.qty[opt.id]=clamp(toNumber(state.qty[opt.id],0)-1,0,opt.maxQty||99); save(); rerender(); };
        const num = document.createElement("div");
        num.className="n";
        num.textContent=String(q);
        const plus = document.createElement("button");
        plus.textContent="+";
        plus.onclick=()=>{ state.qty[opt.id]=clamp(toNumber(state.qty[opt.id],0)+1,0,opt.maxQty||99); save(); rerender(); };
        step.append(minus,num,plus);
        right.appendChild(step);
      }

      // text
      mid.innerHTML = `
        <div class="optName">${opt.name}</div>
        <div class="optMeta">+${won(opt.priceDelta)} · 원가 +${won(opt.costDelta)}</div>
      `;

      // admin inline edit
      if(state.adminOn && opt.adminEditable){
        const wrap = document.createElement("div");
        wrap.className="inlineEdit";

        const m1 = document.createElement("div");
        m1.className="mini";
        m1.innerHTML = `<span>옵션가</span>`;
        const i1 = document.createElement("input");
        i1.type="number";
        i1.value = opt.priceDelta;
        i1.oninput = (e)=>{ opt.priceDelta = toNumber(e.target.value,0); save(); rerender(false); };
        m1.appendChild(i1);

        const m2 = document.createElement("div");
        m2.className="mini";
        m2.innerHTML = `<span>옵션원가</span>`;
        const i2 = document.createElement("input");
        i2.type="number";
        i2.value = opt.costDelta;
        i2.oninput = (e)=>{ opt.costDelta = toNumber(e.target.value,0); save(); rerender(false); };
        m2.appendChild(i2);

        wrap.append(m1,m2);
        mid.appendChild(wrap);
      }

      row.append(left, mid, right);
      body.appendChild(row);
    });

    sec.appendChild(body);
    sections.appendChild(sec);
  });
}

/** =========================
 *  Calculation
 *  ========================= */
function getSelectedLines(){
  const lines = [];

  // radios
  Object.keys(state.radio).forEach(gid=>{
    const id = state.radio[gid];
    const opt = cfg.options.find(o=>o.id===id);
    if(opt) lines.push({opt, qty:1});
  });

  // checks
  Object.keys(state.checked).forEach(id=>{
    if(state.checked[id]){
      const opt = cfg.options.find(o=>o.id===id);
      if(opt) lines.push({opt, qty:1});
    }
  });

  // qty
  Object.keys(state.qty).forEach(id=>{
    const q = clamp(toNumber(state.qty[id],0),0,(cfg.options.find(o=>o.id===id)?.maxQty)||99);
    if(q>0){
      const opt = cfg.options.find(o=>o.id===id);
      if(opt) lines.push({opt, qty:q});
    }
  });

  // check_limit enforcement already handled at click time, but keep safe
  ["TOPPING","SIDE","DRINK"].forEach(gid=>{
    const g = getGroupMeta(gid);
    if(!g) return;
    const max = g.maxSelect || 99;
    const inGroup = cfg.options.filter(o=>o.groupId===gid && o.type==="check" && state.checked[o.id]);
    if(inGroup.length>max){
      // truncate extras
      inGroup.slice(max).forEach(o=>state.checked[o.id]=false);
    }
  });

  return lines;
}

function calcAll(){
  const base = cfg.menu.sizes[state.size];
  const basePrice = toNumber(base.price,0);
  const baseCost = toNumber(base.baseCost,0);

  const lines = getSelectedLines();

  const optPrice = lines.reduce((s,x)=>s + toNumber(x.opt.priceDelta,0)*x.qty,0);
  const optCost  = lines.reduce((s,x)=>s + toNumber(x.opt.costDelta,0)*x.qty,0);

  const gross = basePrice + optPrice;
  const net = Math.max(0, gross - toNumber(state.coupon,0));
  const totalCost = baseCost + optCost;

  const p = cfg.platforms[state.platformKey];
  const platformFee = net * toNumber(p.platformFeeRate,0);
  const cardFee = net * toNumber(p.cardFeeRate,0);
  const delivery = toNumber(p.deliveryFee,0) + toNumber(state.storeDeliveryExtra,0);

  const profit = net - platformFee - cardFee - delivery - totalCost;
  const marginRate = net>0 ? (profit/net)*100 : 0;

  return {basePrice, baseCost, optPrice, optCost, gross, net, totalCost, platformFee, cardFee, delivery, profit, marginRate, lines};
}

function renderSummary(){
  const r = calcAll();
  $("grossPrice").textContent = won(r.gross);
  $("netRevenue").textContent = won(r.net);
  $("totalCost").textContent = won(r.totalCost);
  $("platformFee").textContent = won(r.platformFee);
  $("cardFee").textContent = won(r.cardFee);
  $("deliveryFee").textContent = won(r.delivery);

  const pt = `실마진 (${pct(r.marginRate)})`;
  $("profitTitle").textContent = pt;

  const profitEl = $("profit");
  profitEl.textContent = won(r.profit);
  profitEl.className = "sumValue" + (r.profit<0 ? " bad":"");

  $("ctaProfit").textContent = won(r.profit);
}

function renderOptionProfit(){
  const r = calcAll();
  const rows = [];

  // option 단독 손익 표시(선택된 것만)
  const selected = r.lines.filter(x => x.opt.priceDelta!==0 || x.opt.costDelta!==0 || x.qty>0);
  profitRows.innerHTML = "";

  if(!selected.length){
    profitRows.innerHTML = `<div style="color:#6b7280; font-weight:800">선택된 옵션이 없습니다.</div>`;
    return;
  }

  selected.forEach(x=>{
    const p = toNumber(x.opt.priceDelta,0)*x.qty;
    const c = toNumber(x.opt.costDelta,0)*x.qty;
    const d = p - c;
    const box = document.createElement("div");
    box.className="rowBox";
    box.innerHTML = `
      <div>
        <div style="font-weight:1000">${x.opt.name}${x.qty>1 ? " ×"+x.qty : ""}</div>
        <div style="font-size:12px; color:#6b7280; font-weight:800">${getGroupMeta(x.opt.groupId)?.title || x.opt.groupId}</div>
      </div>
      <div style="text-align:right; font-size:12px; color:#6b7280; font-weight:800">
        +${won(p)}
        <div style="margin-top:4px">원가 +${won(c)}</div>
      </div>
      <div class="divider"></div>
      <div class="profit ${d<0 ? "neg":"pos"}" style="text-align:right">${d<0 ? "" : "+"}${won(d)}</div>
    `;
    profitRows.appendChild(box);
  });
}

/** =========================
 *  Main rerender
 *  ========================= */
function rerender(full=true){
  if(full) renderTop();
  renderSections();
  renderSummary();
  renderOptionProfit();
}

function boot(){
  ensureRadioDefaults();
  hookAdminInputs();
  rerender(true);
}

boot();
</script>
</body>
</html>

